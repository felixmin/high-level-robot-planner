# @package data

# Local OpenX/OXE loading from downloaded HF tar shards (no network streaming).
# Self-contained config (no inherited defaults).

backend: oxe_local_indexed

dataset:
  oxe:
    datasets: []

loader:
  batch_size: 16
  # Local indexed_full uses PyTorch workers (not tf.data streaming workers).
  num_workers: 12
  pin_memory: true
  prefetch_factor: null

preprocess:
  image_size: 256
  return_metadata: true

adapter:
  openx_local:
    # Root directory containing per-dataset shard folders:
    #   <root>/<dataset_name>/*.tar
    root: /mnt/data/oxe
    # indexed: local indexed iteration from shards (IterableDataset)
    # indexed_full: persistent episode index + hierarchical sampler
    # full: materialize samples into RAM (small runs only)
    mode: indexed_full
    # <=0 means "all available shards"
    max_shards_per_dataset: 0
    # <=0 means "all valid pairs per episode"
    pairs_per_episode: 0
    # <=0 means auto (all CPUs)
    index_workers: 0
    # Persistent shard index cache (can be reused across runs)
    index_cache_dir: cache/openx_local_index
    # Rebuild indexed_full episode index even if cache exists
    index_rebuild: false
    # Number of open shard file handles per worker for indexed_full mode
    index_max_open_shards: 16
    # indexed_full: if true, dataset mixture is proportional to pair mass
    weights_by_size: false
    # If true, ignore data.dataset.oxe.datasets and discover all subfolders with *.tar under root
    auto_discover: true
    # Defaults used when auto_discover=true
    auto_train_split: "train[:90%]"
    auto_val_split: "train[90%:]"
    auto_pair_offset_steps: 5
    auto_weight: 1.0
    # used only in mode=full (null = unlimited)
    max_pairs: null
    seed: 42
    resample_each_epoch: true
    # all_exhausted consumes full split; first_exhausted stops when one source ends
    stopping_strategy: all_exhausted
