# @package data.adapter

# TensorFlow/TFDS OXE streaming adapter (tf.data).
# These parameters are ONLY used by the TF backend (not by training/model code).

tf:
  # Metadata emission mode when preprocess.return_metadata=true.
  # - full: include action/state/language/robot/episode fields (current behavior)
  # - dataset_only: emit only dataset_name/dataset_type in Python mixer fast path
  metadata:
    mode: full               # full|dataset_only

  # Frame selection within each [t, t+offset] training sample.
  # Default "endpoints" preserves the current 2-frame output.
  pair_frames:
    mode: endpoints           # endpoints|all|stride|fixed_n
    stride: 1                 # used when mode=stride
    n: 2                      # used when mode=fixed_n

  # Debug/testing helpers (no network/TFDS required when enabled).
  debug:
    use_synthetic_data: false
    synthetic_num_samples: 10000

  # Keep tf.data iterator alive across epochs to avoid re-filling shuffle buffers.
  iterator:
    persistent: true

  # Episode -> pair sampling behaviour.
  sampling:
    samples_per_episode: 0   # 0 = yield all pairs in each episode
    seed: 42

  # Shuffle behaviour (train vs val).
  train:
    episode_queue_shuffle_buffer: 1000
    intra_episode_sample_shuffle_buffer: 200
    global_stream_shuffle_buffer: 5000

  val:
    episode_queue_shuffle_buffer: 0
    intra_episode_sample_shuffle_buffer: 0
    global_stream_shuffle_buffer: 0

  # Prefetch behaviour (memory/throughput trade-off).
  prefetch:
    final_stream_buffer: 8           # after mixing (per-batch)
    per_dataset_stream_buffer: 0     # per-dataset (multiplies memory)
    episode_queue_buffer: 0          # episodes (keep small; episodes can be large)

  # TFDS read (I/O) parallelism.
  tfds_read:
    # Where TFDS `builder_from_directory(...)` should read from.
    # - gcs:  use the `gs://...` paths baked into `common.adapters.oxe.OXE_DATASETS`
    # - local: use a local mirror at `${local_root}/<dataset_dirname>/<version>`
    # - auto: prefer local if present, else fall back to gcs
    source: auto           # gcs|local|auto
    local_root: /dss/dssfs04/pn69za/pn69za-dss-0004/datasets/open-x-embodiment
    # If true, TFDS `steps` are returned as time-major tensors with encoded images
    # (`tf.string`) instead of a Dataset of decoded steps. Used for Octo-like
    # mix-before-decode experiments.
    skip_steps_decoding: false
    cycle_length: 1
    block_length: 1
    decode_parallelism: 1           # -1 = tf.data.AUTOTUNE
    interleave_parallelism: 1       # -1 = tf.data.AUTOTUNE

  # tf.data pipeline parallelism.
  pipeline:
    episode_concurrency: 1
    transform_parallelism: 1
    interleave_parallelism: 1
    emit_encoded_pairs: false
    # If true, and if `tfds_read.skip_steps_decoding=true`, decode+resize happens
    # after dataset mixing (in MultiOXEFramePairDataset) instead of inside each
    # per-dataset pipeline.
    post_mix_decode_resize: false

  # Multi-dataset mixing behaviour.
  mixing:
    mix_block_length: 1              # 1 = per-sample mixing
    selector_run_length: 1           # repeat dataset choice N batches (reduces switch stalls)
    parallelism_mode: full           # divide|sqrt|full
    strategy: sample                 # sample|choose|python
    python_prefetch_queue_size: 2
    python_prefetch_min_ready_datasets: 1
    python_prefetch_wait_timeout_s: 600
    per_dataset_private_threadpool_size: 16
