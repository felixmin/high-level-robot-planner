# @package _global_

# LAQ training on multiple OXE datasets
# Combines Language Table and Bridge with weighted interleaving

defaults:
  - /model@model: laq
  - /data@data: laq_oxe_multi
  - /training@training: laq_optimizer
  - /cluster@cluster: local_dev

experiment:
  name: laq_oxe_multi
  description: LAQ training on combined OXE datasets (language_table + bridge)

# Model settings
model:
  image_size: 256
  use_dinov3_encoder: true
  dinov3_model_name: "facebook/dinov3-vits16-pretrain-lvd1689m"
  dinov3_pool_to_grid: 8

# Data settings - conservative for multi-dataset
data:
  batch_size: 32
  shuffle_buffer: 500  # Split across datasets
  prefetch_buffer: 4

# Training settings
training:
  epochs: 100
  max_steps: null
  scheduler:
    type: none
  validation:
    check_interval: 1000
    limit_batches: 100
    max_cached_samples: 256
    num_fixed_samples: 8
    num_random_samples: 8
    # Buckets to track per-dataset metrics
    buckets:
      language_table:
        filters: {dataset_name: "language_table"}
        max_samples: 128
      bridge:
        filters: {dataset_name: "bridge"}
        max_samples: 128
    # --- Validation Strategies (Composition Pattern) ---
    # Each strategy instance is self-contained with its own bucket bindings
    # Use 'type' field to specify strategy class, instance name becomes metric name
    strategies:
      # Basic visualization - runs on all data (no bucket binding)
      basic:
        enabled: true
        visualize_train: true
        visualize_val: true
        visualize_per_bucket: true

      # Global strategies (run on combined data)
      codebook_histogram:
        enabled: true
        every_n_validations: 3
      sequence_histogram:
        enabled: true
        every_n_validations: 5
        num_top_sequences: 30
      all_sequences_histogram:
        enabled: true
        every_n_validations: 5
      clustering:
        enabled: true
        every_n_validations: 5
        num_samples: 256

      # Per-bucket latent transfer (compare distribution shift)
      transfer_lt:
        type: latent_transfer
        buckets: ["language_table"]
        every_n_validations: 5
        num_pairs: 128
      transfer_bridge:
        type: latent_transfer
        buckets: ["bridge"]
        every_n_validations: 5
        num_pairs: 128

      # Action scatter only on language_table (has 2D actions)
      action_scatter_lt:
        type: action_token_scatter
        buckets: ["language_table"]
        every_n_validations: 3
        num_samples: 256
      action_seq_lt:
        type: action_sequence_scatter
        buckets: ["language_table"]
        every_n_validations: 5
        num_samples: 256
      top_seq_lt:
        type: top_sequences_scatter
        buckets: ["language_table"]
        every_n_validations: 5
        num_top_sequences: 5
      state_scatter_lt:
        type: state_sequence_scatter
        buckets: ["language_table"]
        every_n_validations: 5
        num_samples: 256

logging:
  use_wandb: true
  tags: ["oxe", "multi-dataset", "language_table", "bridge", "laq", "streaming"]
