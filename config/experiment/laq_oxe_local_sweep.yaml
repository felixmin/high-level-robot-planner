# @package _global_

# Minimal local OXE run (RAM-safe):
# - no shuffle buffers
# - no prefetching
# - tiny splits + tiny batch size

defaults:
  - /model@model: laq
  - /data@data: oxe_local_indexed
  - /training@training: laq_optimizer
  - /cluster@cluster: local_dev

hydra:
  mode: MULTIRUN
  sweeper:
    params:
      model.dim: 256, 512, 1024


experiment:
  name: laq_oxe_local_sweep_model_dim_${model.dim}
  description: "Latent Action Model Sweep"

data:
  loader:
    batch_size: 32

training:
  max_steps: 20010
  progress_bar:
    enabled: true
    refresh_rate: 10
    leave: false
  model_summary:
    enabled: true
  profiler:
    enabled: true
    type: advanced
    filename: fit-profile
  throughput:
    enabled: true
  dataset_usage_logger:
    enabled: false
  validation:
    #check_interval: 1000
    # Keep local validations snappy; increase for more reliable metrics.
    limit_batches: 50
    max_cached_samples: 100
    num_fixed_samples: 4
    num_random_samples: 4
    # Buckets for each OXE dataset (enables per-dataset validation + per-bucket viz)
    buckets:
      language_table:
        filters: {dataset_name: "language_table"}
        max_samples: 10
      bridge:
        filters: {dataset_name: "bridge"}
        max_samples: 10
      rt1:
        filters: {dataset_name: "rt1"}
        max_samples: 10
      robonet:
        filters: {dataset_name: "robonet"}
        max_samples: 10

    # --- Validation Strategies ---
    # NOTE: these must be nested under `strategies:`. If they are aligned with
    # `strategies:`, Hydra/OmegaConf will set `strategies` to null and the
    # callbacks will register 0 strategies (no reconstructions logged).
    strategies:
      # Reconstructions (wandb images) + per-bucket grids.
      basic:
        enabled: true
        every_n_validations: 1
        num_fixed_samples: 4
        num_random_samples: 4
        visualize_train: true
        visualize_val: true
        visualize_per_bucket: true

      # Flow comparisons (only logs if `model.flow.enabled=true` and flow teacher/decoder exist).
      flow_visualization:
        enabled: true
        every_n_validations: 1
        num_samples: 8

      # Global analyses (compute codebook indices on the validation run).
      codebook_histogram:
        enabled: true
        every_n_validations: 4
      sequence_histogram:
        enabled: true
        every_n_validations: 4
        num_top_sequences: 50
      all_sequences_histogram:
        enabled: true
        every_n_validations: 4
      sequence_examples:
        enabled: true
        every_n_validations: 4
        top_k_sequences: 16
        examples_per_sequence: 4

      # Per-dataset scatter plots (require per-batch code extraction; opt-in locally).
      action_scatter_language_table:
        type: action_token_scatter
        buckets: ["language_table"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      action_scatter_bridge:
        type: action_token_scatter
        buckets: ["bridge"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      action_scatter_rt1:
        type: action_token_scatter
        buckets: ["rt1"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      action_scatter_robonet:
        type: action_token_scatter
        buckets: ["robonet"]
        enabled: false
        every_n_validations: 4
        num_samples: 128

      action_seq_language_table:
        type: action_sequence_scatter
        buckets: ["language_table"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      action_seq_bridge:
        type: action_sequence_scatter
        buckets: ["bridge"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      action_seq_rt1:
        type: action_sequence_scatter
        buckets: ["rt1"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      action_seq_robonet:
        type: action_sequence_scatter
        buckets: ["robonet"]
        enabled: false
        every_n_validations: 4
        num_samples: 128

      top_seq_language_table:
        type: top_sequences_scatter
        buckets: ["language_table"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
        num_top_sequences: 5
      top_seq_bridge:
        type: top_sequences_scatter
        buckets: ["bridge"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
        num_top_sequences: 5
      top_seq_rt1:
        type: top_sequences_scatter
        buckets: ["rt1"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
        num_top_sequences: 5
      top_seq_robonet:
        type: top_sequences_scatter
        buckets: ["robonet"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
        num_top_sequences: 5

      state_scatter_language_table:
        type: state_sequence_scatter
        buckets: ["language_table"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      state_scatter_bridge:
        type: state_sequence_scatter
        buckets: ["bridge"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      state_scatter_rt1:
        type: state_sequence_scatter
        buckets: ["rt1"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
      state_scatter_robonet:
        type: state_sequence_scatter
        buckets: ["robonet"]
        enabled: false
        every_n_validations: 4
        num_samples: 128
