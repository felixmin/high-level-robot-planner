# @package _global_

# LAQ training on all 4 OXE datasets with:
# - Flow-only training (no DINO decoder, no aux decoder)
# - Optical flow supervision via RAFT knowledge distillation
# - Flow visualization validation strategy (no reconstruction visualization)
#
# Tests pure flow-based latent learning without reconstruction objectives.

defaults:
  - /model@model: laq
  - /data@data: laq_oxe_all
  - /training@training: laq_optimizer
  - /cluster@cluster: lrz_h100

experiment:
  name: laq_oxe_all_val_5
  description: "LAQ on all OXE datasets with flow-only training (no aux decoder)"

# Model settings
model:
  image_size: 256
  use_dinov3_encoder: true
  dinov3_model_name: "facebook/dinov3-vits16-pretrain-lvd1689m"
  dinov3_pool_to_grid: 8
  code_seq_len: 1
  codebook_size: 4096
  # Training decoders - FLOW ONLY
  use_dino_decoder: false  # Disabled - no DINO token prediction
  use_pixel_decoder: false # Disabled - no pixel prediction with gradients
  # Interpretability decoder
  use_aux_decoder: false   # Disabled - no reconstruction visualization

  # Flow supervision: predict optical flow from latent + context
  # This is the ONLY training objective
  flow:
    model: raft_large
    loss_weight: 1.0       # Flow is normalized, so weight ~1.0 is appropriate
    decoder_depth: 4       # Lighter than main decoder
    warmup_steps: 0        # No warmup needed - flow is the only objective

# Data settings
data:
  batch_size: 64
  shuffle_buffer: 200
  prefetch_buffer: 16
  persistent_iterator: true
  num_workers: 0

# Training settings
training:
  epochs: 100
  max_steps: null
  scheduler:
    type: none
  validation:
    check_interval: 1000
    limit_batches: 500
    max_cached_samples: 512
    num_fixed_samples: 8
    num_random_samples: 8

    # Buckets for each OXE dataset
    buckets:
      language_table:
        filters: {dataset_name: "language_table"}
        max_samples: 128
      bridge:
        filters: {dataset_name: "bridge"}
        max_samples: 128
      rt1:
        filters: {dataset_name: "rt1"}
        max_samples: 128
      robonet:
        filters: {dataset_name: "robonet"}
        max_samples: 128

    # --- Validation Strategies ---
    strategies:
      # === Basic visualization DISABLED (no aux decoder) ===
      basic:
        enabled: false  # Cannot visualize reconstructions without aux decoder

      # === Flow visualization (primary visualization for this experiment) ===
      flow_visualization:
        enabled: true
        every_n_validations: 1
        num_samples: 8

      # === Global strategies (every 3 validations) ===
      codebook_histogram:
        enabled: true
        every_n_validations: 3
      sequence_histogram:
        enabled: true
        every_n_validations: 3
        num_top_sequences: 50
      all_sequences_histogram:
        enabled: true
        every_n_validations: 3
      sequence_examples:
        enabled: true
        every_n_validations: 3
        top_k_sequences: 16
        examples_per_sequence: 4

      # === Per-dataset Latent Transfer DISABLED (requires aux decoder) ===
      # Latent transfer visualizes reconstructions, which need aux decoder

      # === Per-dataset Action Token Scatter ===
      action_scatter_language_table:
        type: action_token_scatter
        buckets: ["language_table"]
        every_n_validations: 3
        num_samples: 256
      action_scatter_bridge:
        type: action_token_scatter
        buckets: ["bridge"]
        every_n_validations: 3
        num_samples: 256
      action_scatter_rt1:
        type: action_token_scatter
        buckets: ["rt1"]
        every_n_validations: 3
        num_samples: 256
      action_scatter_robonet:
        type: action_token_scatter
        buckets: ["robonet"]
        every_n_validations: 3
        num_samples: 256

      # === Per-dataset Action Sequence Scatter ===
      action_seq_language_table:
        type: action_sequence_scatter
        buckets: ["language_table"]
        every_n_validations: 3
        num_samples: 256
      action_seq_bridge:
        type: action_sequence_scatter
        buckets: ["bridge"]
        every_n_validations: 3
        num_samples: 256
      action_seq_rt1:
        type: action_sequence_scatter
        buckets: ["rt1"]
        every_n_validations: 3
        num_samples: 256
      action_seq_robonet:
        type: action_sequence_scatter
        buckets: ["robonet"]
        every_n_validations: 3
        num_samples: 256

      # === Per-dataset Top Sequences Scatter ===
      top_seq_language_table:
        type: top_sequences_scatter
        buckets: ["language_table"]
        every_n_validations: 3
        num_samples: 256
        num_top_sequences: 5
      top_seq_bridge:
        type: top_sequences_scatter
        buckets: ["bridge"]
        every_n_validations: 3
        num_samples: 256
        num_top_sequences: 5
      top_seq_rt1:
        type: top_sequences_scatter
        buckets: ["rt1"]
        every_n_validations: 3
        num_samples: 256
        num_top_sequences: 5
      top_seq_robonet:
        type: top_sequences_scatter
        buckets: ["robonet"]
        every_n_validations: 3
        num_samples: 256
        num_top_sequences: 5

      # === Per-dataset State Sequence Scatter ===
      state_scatter_language_table:
        type: state_sequence_scatter
        buckets: ["language_table"]
        every_n_validations: 3
        num_samples: 256
      state_scatter_bridge:
        type: state_sequence_scatter
        buckets: ["bridge"]
        every_n_validations: 3
        num_samples: 256
      state_scatter_rt1:
        type: state_sequence_scatter
        buckets: ["rt1"]
        every_n_validations: 3
        num_samples: 256
      state_scatter_robonet:
        type: state_sequence_scatter
        buckets: ["robonet"]
        every_n_validations: 3
        num_samples: 256

logging:
  unified: true
  level: INFO
  use_wandb: true
  project: hlrp
  tags: ["oxe", "all-datasets", "flow-only", "no-aux", "laq"]
