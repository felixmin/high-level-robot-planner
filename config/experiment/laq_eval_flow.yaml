# @package _global_

# Evaluation run to visualize flow predictions
# Runs minimal training steps just to trigger validation visualizations

defaults:
  - /model@model: laq
  - /data@data: laq_oxe_all_low_ram
  - /training@training: laq_optimizer
  - /cluster@cluster: local_dev
  - optional /user_config: local

experiment:
  name: laq_eval_flow_viz
  description: "Evaluate LAQ checkpoint with flow visualizations"

seed: 42

model:
  image_size: 256
  use_dinov3_encoder: true
  dinov3_model_name: "facebook/dinov3-vits16-pretrain-lvd1689m"
  dinov3_pool_to_grid: 8
  code_seq_len: 4
  codebook_size: 8
  use_dino_decoder: true
  use_pixel_decoder: false
  use_aux_decoder: true
  codebook_replace_schedule: []

  # Enable flow for visualization
  flow:
    enabled: true
    model: raft_small
    loss_weight: 0.1
    decoder_depth: 2
    warmup_steps: 0  # No warmup needed for eval
    teacher_num_flow_updates: 6
    teacher_chunk_size: 64

data:
  loader:
    batch_size: 32
    num_workers: 0

training:
  # Load the trained checkpoint
  load_weights_from: "/mnt/data/workspace/runs/hlrp/2026-02-02_10-58-35_laq_continue_with_flow/checkpoints/laq-stepstep=080000.ckpt"

  # Run just enough to trigger validations
  max_steps: 100
  epochs: 1

  validation:
    check_interval: 50  # Validate twice
    limit_batches: 100
    max_cached_samples: 256
    num_fixed_samples: 16
    num_random_samples: 16

    buckets:
      language_table:
        filters: {dataset_name: "language_table"}
        max_samples: 64
      bridge:
        filters: {dataset_name: "bridge"}
        max_samples: 64
      rt1:
        filters: {dataset_name: "rt1"}
        max_samples: 64

    strategies:
      # Basic reconstruction visualization
      basic:
        enabled: true
        every_n_validations: 1
        visualize_train: true
        visualize_val: true
        visualize_per_bucket: true

      # Flow visualization - the main thing we want
      flow_visualization:
        enabled: true
        every_n_validations: 1
        num_samples: 16

      # Codebook analysis
      codebook_histogram:
        enabled: true
        every_n_validations: 1

      # Sequence analysis
      sequence_histogram:
        enabled: true
        every_n_validations: 1
        num_top_sequences: 50

      # Action scatter plots (requires action metadata)
      action_scatter_lt:
        type: action_token_scatter
        buckets: ["language_table"]
        every_n_validations: 1
        num_samples: 500

      action_scatter_bridge:
        type: action_token_scatter
        buckets: ["bridge"]
        every_n_validations: 1
        num_samples: 500

      # Latent transfer test
      transfer_lt:
        type: latent_transfer
        buckets: ["language_table"]
        every_n_validations: 1
        num_pairs: 64

      transfer_bridge:
        type: latent_transfer
        buckets: ["bridge"]
        every_n_validations: 1
        num_pairs: 64

logging:
  level: INFO
  use_wandb: true
  project: hlrp
  tags: ["eval", "flow-viz", "laq"]
