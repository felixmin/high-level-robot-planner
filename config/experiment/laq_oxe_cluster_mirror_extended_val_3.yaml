# @package _global_

# LAQ training on the expanded OXE dataset set aligned with the LRZ cluster mirror.
#
# This is the "prod" config (full TFDS splits). For fast local checks/benchmarks,
# use `data=laq_oxe_cluster_mirror_extended_smoke` instead.

defaults:
  - /model@model: laq
  - /data@data: laq_oxe_cluster_mirror_extended
  - /training@training: laq_optimizer
  - /cluster@cluster: lrz_h100
  - optional /user_config: local

experiment:
  name: laq_oxe_cluster_mirror_extended_val_3
  description: "LAQ on expanded OXE datasets (cluster mirror aligned) with aux loss + flow supervision"

# Model settings (copied from laq_oxe_all_val_3)
model:
  image_size: 256
  use_dinov3_encoder: true
  dinov3_model_name: "facebook/dinov3-vits16-pretrain-lvd1689m"
  dinov3_pool_to_grid: 8
  code_seq_len: 4
  codebook_size: 8
  use_dino_decoder: true
  use_pixel_decoder: false
  use_aux_decoder: true
  flow:
    model: raft_large
    loss_weight: 1.0
    decoder_depth: 4
    warmup_steps: 10000

data:
  loader:
    batch_size: 64
    num_workers: 0
  adapter:
    tf:
      train:
        episode_queue_shuffle_buffer: 200
        intra_episode_sample_shuffle_buffer: 0
        global_stream_shuffle_buffer: 200
      prefetch:
        final_stream_buffer: 16
      iterator:
        persistent: true

training:
  profiler:
    enabled: true
    type: simple
    dirpath: ./profiles
    filename: profile
  epochs: 100
  max_steps: null
  validation:
    check_interval: 1000
    limit_batches: 500
    max_cached_samples: 512
    num_fixed_samples: 8
    num_random_samples: 8

    buckets:
      language_table:
        filters: {dataset_name: "language_table"}
        max_samples: 128
      bridge:
        filters: {dataset_name: "bridge"}
        max_samples: 128
      rt1:
        filters: {dataset_name: "rt1"}
        max_samples: 128
      robonet:
        filters: {dataset_name: "robonet"}
        max_samples: 128
      aloha_mobile:
        filters: {dataset_name: "aloha_mobile"}
        max_samples: 128
      droid:
        filters: {dataset_name: "droid"}
        max_samples: 128
      berkeley_autolab_ur5:
        filters: {dataset_name: "berkeley_autolab_ur5"}
        max_samples: 128
      jaco_play:
        filters: {dataset_name: "jaco_play"}
        max_samples: 128
      kuka:
        filters: {dataset_name: "kuka"}
        max_samples: 128
      taco_play:
        filters: {dataset_name: "taco_play"}
        max_samples: 128
      roboturk:
        filters: {dataset_name: "roboturk"}
        max_samples: 128

    strategies:
      basic:
        enabled: true
        every_n_validations: 1
        visualize_train: true
        visualize_val: true
        visualize_per_bucket: true
      flow_visualization:
        enabled: true
        every_n_validations: 1
        num_samples: 8
      codebook_histogram:
        enabled: true
        every_n_validations: 3
      sequence_histogram:
        enabled: true
        every_n_validations: 3
        num_top_sequences: 50
      all_sequences_histogram:
        enabled: true
        every_n_validations: 3
      sequence_examples:
        enabled: true
        every_n_validations: 3
        top_k_sequences: 16

